<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Paradox Prism: Final Edition</title>
    <style>
        body { margin: 0; background: #000; color: #0ff; font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #container { position: relative; border: 4px solid #333; box-shadow: 0 0 20px #0ff; }
        #ui { position: absolute; top: 15px; left: 15px; pointer-events: none; font-size: 18px; }
        canvas { display: block; background: #050505; }
        .controls { position: absolute; bottom: 15px; width: 100%; text-align: center; color: #444; font-size: 12px; }
    </style>
</head>
<body>
    <div id="container">
        <div id="ui">LEVEL: <span id="lvl">1</span> | PHASE: <span id="phase">BLUE</span></div>
        <canvas id="game"></canvas>
        <div class="controls">WASD / ARROWS to Move | SPACE to Shift Reality</div>
    </div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    canvas.width = 800;
    canvas.height = 600;

    let levelIdx = 0;
    let phase = 'BLUE';
    const keys = {};

    // 1=Wall, 2=Blue, 3=Red, 4=Goal, 5=Spike, P=Player Start
    const levels = [
        [
            "1111111111111111",
            "1P02000000000001",
            "1110000000000001",
            "1000003333000001",
            "1000000000000331",
            "1000330000000341",
            "1111111111111111"
        ],
        [
            "1111111111111111",
            "1P00100000000001",
            "1110120150000001",
            "1000102550000001",
            "1000010550000001",
            "1000003550000041",
            "1111111111111111"
        ],
        [
            "1111111111111111",
            "1P00001000000041",
            "1110001002221111",
            "1000001020000001",
            "1022201033300301",
            "1000000000035551",
            "1111111111111111"
        ],
        [
            "1111111111111111",
            "1000000000000001",
            "1000000000000001",
            "1000000000000001",
            "1P02003002003001",
            "1015555555555041",
            "1111111111111111"
        ],
        [
            "1111111111111111",
            "1000000000000001",
            "1000000000000001",
            "1000000000000001",
            "1000000000000001",
            "1000000000000001",
            "1111111111111111"
        ]
    ];

    const player = { x: 0, y: 0, w: 24, h: 24, vx: 0, vy: 0, speed: 5, jump: -12, grounded: false };

    function initLevel() {
        const map = levels[levelIdx % levels.length];
        const rows = map.length;
        const cols = map[0].length;
        const tw = canvas.width / cols;
        const th = canvas.height / rows;

        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                if(map[r][c] === 'P') {
                    player.x = c * tw + (tw/2 - player.w/2);
                    player.y = r * th + (th/2 - player.h/2);
                    player.vx = 0; player.vy = 0;
                }
            }
        }
        document.getElementById('lvl').innerText = levelIdx + 1;
    }

    window.onkeydown = e => {
        keys[e.code] = true;
        if(e.code === 'Space') {
            phase = phase === 'BLUE' ? 'RED' : 'BLUE';
            document.getElementById('phase').innerText = phase;
            document.getElementById('phase').style.color = phase === 'BLUE' ? '#0af' : '#f05';
        }
    };
    window.onkeyup = e => keys[e.code] = false;

    function update() {
        const map = levels[levelIdx % levels.length];
        const rows = map.length;
        const cols = map[0].length;
        const tw = canvas.width / cols;
        const th = canvas.height / rows;

        // Input
        if(keys['ArrowLeft'] || keys['KeyA']) player.vx = -player.speed;
        else if(keys['ArrowRight'] || keys['KeyD']) player.vx = player.speed;
        else player.vx *= 0.8;

        player.vy += 0.6; // Gravity
        
        // Move X
        player.x += player.vx;
        collide(tw, th, map, true);
        
        // Move Y
        player.y += player.vy;
        player.grounded = false;
        collide(tw, th, map, false);

        if((keys['ArrowUp'] || keys['KeyW']) && player.grounded) {
            player.vy = player.jump;
            player.grounded = false;
        }

        // Draw
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                const char = map[r][c];
                if(char === '0' || char === 'P') continue;
                
                if(char === '1') ctx.fillStyle = '#333';
                else if(char === '2') { ctx.fillStyle = '#0af'; ctx.globalAlpha = (phase === 'BLUE' ? 1 : 0.2); }
                else if(char === '3') { ctx.fillStyle = '#f05'; ctx.globalAlpha = (phase === 'RED' ? 1 : 0.2); }
                else if(char === '4') ctx.fillStyle = '#0f0';
                else if(char === '5') ctx.fillStyle = '#f00';

                ctx.fillRect(c*tw, r*th, tw, th);
                ctx.globalAlpha = 1;
            }
        }

        // Draw Player
        ctx.fillStyle = (phase === 'BLUE' ? '#0af' : '#f05');
        ctx.fillRect(player.x, player.y, player.w, player.h);
        ctx.strokeStyle = '#fff';
        ctx.strokeRect(player.x, player.y, player.w, player.h);

        requestAnimationFrame(update);
    }

    function collide(tw, th, map, isX) {
        const rows = map.length;
        const cols = map[0].length;

        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                const char = map[r][c];
                if(char === '0' || char === 'P') continue;
                if(char === '2' && phase === 'RED') continue;
                if(char === '3' && phase === 'BLUE') continue;

                const tx = c * tw;
                const ty = r * th;

                if(player.x < tx + tw && player.x + player.w > tx &&
                   player.y < ty + th && player.y + player.h > ty) {
                    
                    if(char === '4') { levelIdx++; initLevel(); return; }
                    if(char === '5') { initLevel(); return; }

                    if(isX) {
                        if(player.vx > 0) player.x = tx - player.w;
                        if(player.vx < 0) player.x = tx + tw;
                        player.vx = 0;
                    } else {
                        if(player.vy > 0) { player.y = ty - player.h; player.grounded = true; }
                        if(player.vy < 0) player.y = ty + th;
                        player.vy = 0;
                    }
                }
            }
        }
    }

    initLevel();
    update();
</script>
</body>
</html>